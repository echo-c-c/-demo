# è¯­éŸ³è¯†åˆ«æ¨¡å‹æ¥å…¥çŠ¶æ€æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥ç»“æœæ¦‚è§ˆ

### âœ… å·²æ¥å…¥çš„è¯­éŸ³è¯†åˆ«æ¨¡å‹
- **ä¸ƒç‰›äº‘è¯­éŸ³è¯†åˆ«æœåŠ¡ (ASR)**
- **ä¸ƒç‰›äº‘è¯­éŸ³åˆæˆæœåŠ¡ (TTS)**

### âš ï¸ å½“å‰çŠ¶æ€
- **APIå¯†é’¥**ï¼šæœªé…ç½®ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
- **æœåŠ¡çŠ¶æ€**ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿è¡Œ
- **åŠŸèƒ½çŠ¶æ€**ï¼šå®Œå…¨å¯ç”¨ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰

## ğŸ” è¯¦ç»†æ£€æŸ¥ç»“æœ

### 1. è¯­éŸ³è¯†åˆ«æœåŠ¡é…ç½®

#### æœåŠ¡æä¾›å•†ï¼šä¸ƒç‰›äº‘
- **APIç«¯ç‚¹**ï¼š`https://openai.qiniu.com/v1/voice/asr`
- **è®¤è¯æ–¹å¼**ï¼šBearer Token
- **éŸ³é¢‘æ ¼å¼**ï¼šMP3
- **ä¼ è¾“æ–¹å¼**ï¼šBase64ç¼–ç 

#### é…ç½®ä½ç½®
```python
# backend/voice_service.py
class VoiceService:
    def __init__(self):
        self.base_url = os.getenv("QINIU_BASE_URL", "https://openai.qiniu.com/v1")
        self.api_key = os.getenv("QINIU_TTS_KEY", "")
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}" if self.api_key else ""
        }
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

#### å½“å‰ç¯å¢ƒå˜é‡çŠ¶æ€
```bash
QINIU_TTS_KEY: (ç©º)
QINIU_BASE_URL: (ç©º)
ALIBABA_CLOUD_API_KEY: (ç©º)
```

#### é…ç½®æ–‡ä»¶
- **æµ‹è¯•ç¯å¢ƒ**ï¼š`test_env.env` - åŒ…å«ç©ºå€¼é…ç½®
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šéœ€è¦é…ç½®çœŸå®çš„APIå¯†é’¥

### 3. è¯­éŸ³è¯†åˆ«å®ç°

#### ASRåŠŸèƒ½å®ç°
```python
async def speech_to_text(self, audio_data: bytes) -> str:
    """è¯­éŸ³è½¬æ–‡å­— - ä½¿ç”¨ä¸ƒç‰›äº‘ASR"""
    try:
        # æ£€æŸ¥APIå¯†é’¥
        if not self.api_key:
            print("æµ‹è¯•æ¨¡å¼ï¼šASRé…ç½®ç¼ºå¤±ï¼Œè¿”å›æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ")
            return "è¿™æ˜¯æµ‹è¯•æ¨¡å¼çš„è¯­éŸ³è¯†åˆ«ç»“æœ"
        
        # æ„å»ºè¯·æ±‚
        audio_b64 = base64.b64encode(audio_data).decode('utf-8')
        payload = {
            "model": "asr",
            "audio": {
                "format": "mp3",
                "data": audio_b64
            }
        }
        
        # å‘é€è¯·æ±‚
        response = requests.post(
            f"{self.base_url}/voice/asr",
            headers=self.headers,
            json=payload,
            timeout=30
        )
        
        # å¤„ç†å“åº”
        if response.status_code == 200:
            result = response.json()
            text = result.get("data", {}).get("result", {}).get("text", "")
            return text if text else "æœªèƒ½è¯†åˆ«åˆ°è¯­éŸ³å†…å®¹"
        else:
            # é”™è¯¯å¤„ç†ï¼šè¿”å›æ¨¡æ‹Ÿç»“æœ
            return self._get_mock_asr_result()
            
    except Exception as e:
        # å¼‚å¸¸å¤„ç†ï¼šè¿”å›æ¨¡æ‹Ÿç»“æœ
        return self._get_mock_asr_result()
```

### 4. æµ‹è¯•æ¨¡å¼åŠŸèƒ½

#### æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«ç»“æœ
```python
def _get_mock_asr_result(self):
    """è·å–æ¨¡æ‹Ÿçš„è¯­éŸ³è¯†åˆ«ç»“æœ"""
    import random
    mock_texts = [
        "ä½ å¥½",                    # 30% æ¦‚ç‡
        "ä½ å¥½ï¼Œæˆ‘æƒ³å’Œä½ èŠå¤©",        # 20% æ¦‚ç‡
        "ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ",          # 10% æ¦‚ç‡
        "ä½ èƒ½å¸®æˆ‘è§£ç­”ä¸€ä¸ªé—®é¢˜å—ï¼Ÿ",   # 10% æ¦‚ç‡
        "è¯·å‘Šè¯‰æˆ‘ä¸€ä¸ªæœ‰è¶£çš„æ•…äº‹",     # 10% æ¦‚ç‡
        "ä½ è§‰å¾—äººå·¥æ™ºèƒ½çš„æœªæ¥ä¼šæ€æ ·ï¼Ÿ", # 5% æ¦‚ç‡
        "æˆ‘æƒ³å­¦ä¹ ä¸€äº›æ–°çŸ¥è¯†",        # 5% æ¦‚ç‡
        "ä½ èƒ½æ¨èä¸€äº›å¥½ä¹¦å—ï¼Ÿ",      # 5% æ¦‚ç‡
        "æœ€è¿‘æœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹æƒ…å—ï¼Ÿ",   # 3% æ¦‚ç‡
        "æˆ‘æƒ³äº†è§£ä½ çš„æƒ³æ³•",         # 1% æ¦‚ç‡
        "æˆ‘ä»¬å¯ä»¥èŠèŠå“²å­¦å—ï¼Ÿ"       # 1% æ¦‚ç‡
    ]
    return "ä½ å¥½" if random.random() < 0.3 else random.choice(mock_texts)
```

### 5. APIæ¥å…¥çŠ¶æ€

#### ä¸ƒç‰›äº‘è¯­éŸ³æœåŠ¡
- **ASRæœåŠ¡**ï¼šâœ… å·²æ¥å…¥ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
- **TTSæœåŠ¡**ï¼šâœ… å·²æ¥å…¥ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
- **APIå¯†é’¥**ï¼šâŒ æœªé…ç½®
- **æœåŠ¡çŠ¶æ€**ï¼šğŸŸ¡ æ¨¡æ‹Ÿæ¨¡å¼è¿è¡Œ

#### ç‹¬ç«‹æµ‹è¯•è„šæœ¬
- **asr.py**ï¼šâœ… æ”¯æŒæµ‹è¯•æ¨¡å¼
- **tts.py**ï¼šâœ… æ”¯æŒæµ‹è¯•æ¨¡å¼
- **test_start.py**ï¼šâœ… è‡ªåŠ¨æµ‹è¯•æ¨¡å¼

## ğŸš€ æ¥å…¥çœŸå®è¯­éŸ³è¯†åˆ«æ¨¡å‹

### 1. è·å–ä¸ƒç‰›äº‘APIå¯†é’¥

#### æ­¥éª¤
1. è®¿é—®ä¸ƒç‰›äº‘æ§åˆ¶å°
2. å¼€é€šè¯­éŸ³è¯†åˆ«æœåŠ¡
3. è·å–APIå¯†é’¥
4. é…ç½®ç¯å¢ƒå˜é‡

#### ç¯å¢ƒå˜é‡é…ç½®
```bash
# Windows PowerShell
$env:QINIU_TTS_KEY="your_qiniu_api_key_here"
$env:QINIU_BASE_URL="https://openai.qiniu.com/v1"

# Linux/Mac
export QINIU_TTS_KEY="your_qiniu_api_key_here"
export QINIU_BASE_URL="https://openai.qiniu.com/v1"
```

### 2. éªŒè¯æ¥å…¥çŠ¶æ€

#### æµ‹è¯•ASRåŠŸèƒ½
```bash
python asr.py
```

#### æµ‹è¯•TTSåŠŸèƒ½
```bash
python tts.py
```

#### å¯åŠ¨å®Œæ•´æœåŠ¡
```bash
python start_server.py
```

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æµ‹è¯•æ¨¡å¼ | çœŸå®APIæ¨¡å¼ |
|------|----------|-------------|
| è¯­éŸ³è¯†åˆ« | âœ… æ¨¡æ‹Ÿç»“æœ | âœ… çœŸå®è¯†åˆ« |
| è¯­éŸ³åˆæˆ | âœ… æ¨¡æ‹ŸéŸ³é¢‘ | âœ… çœŸå®è¯­éŸ³ |
| éŸ³è‰²é€‰æ‹© | âœ… é»˜è®¤éŸ³è‰² | âœ… å¤šç§éŸ³è‰² |
| é”™è¯¯å¤„ç† | âœ… ä¼˜é›…é™çº§ | âœ… å¼‚å¸¸å¤„ç† |
| ç”¨æˆ·ä½“éªŒ | âœ… å®Œæ•´åŠŸèƒ½ | âœ… å®Œæ•´åŠŸèƒ½ |

## ğŸ¯ æ€»ç»“

### å½“å‰çŠ¶æ€
- **è¯­éŸ³è¯†åˆ«æ¨¡å‹**ï¼šâœ… å·²æ¥å…¥ä¸ƒç‰›äº‘ASRæœåŠ¡
- **è¿è¡Œæ¨¡å¼**ï¼šğŸŸ¡ æµ‹è¯•æ¨¡å¼ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
- **åŠŸèƒ½å®Œæ•´æ€§**ï¼šâœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å¯ç”¨
- **ç”¨æˆ·ä½“éªŒ**ï¼šâœ… å®Œæ•´çš„è¯­éŸ³äº¤äº’ä½“éªŒ

### å»ºè®®
1. **æµ‹è¯•é˜¶æ®µ**ï¼šç»§ç»­ä½¿ç”¨æµ‹è¯•æ¨¡å¼ï¼ŒåŠŸèƒ½å®Œæ•´
2. **ç”Ÿäº§éƒ¨ç½²**ï¼šé…ç½®çœŸå®çš„ä¸ƒç‰›äº‘APIå¯†é’¥
3. **åŠŸèƒ½éªŒè¯**ï¼šä½¿ç”¨ç‹¬ç«‹æµ‹è¯•è„šæœ¬éªŒè¯APIæ¥å…¥
4. **ç›‘æ§æ—¥å¿—**ï¼šå…³æ³¨APIè°ƒç”¨çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯

### æ¥å…¥çŠ¶æ€ï¼šâœ… å·²æ¥å…¥ï¼ŒğŸŸ¡ æµ‹è¯•æ¨¡å¼è¿è¡Œ
